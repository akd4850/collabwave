<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gdu.myapp.mapper.EmpMapper">
	
	<resultMap type="EmpDto" id="EmpDtoMap">
	    <id property="empCode" column="EMP_CODE" />
	    <result property="empName" column="EMP_NAME" />
	    <result property="password" column="PASSWORD" />
	    <result property="phone" column="PHONE" />
	    <result property="mobile" column="MOBILE" />
	    <result property="email" column="EMAIL" />
	    <result property="address" column="ADDRESS" />
	    <result property="detailAddress" column="DETAIL_ADDRESS" />
	    <result property="signFileName" column="SIGN_FILE_NAME" />
	    <result property="profileFileName" column="PROFILE_FILE_NAME" />
	    <result property="statusCode" column="STATUS_CODE" />
	    <result property="zipCode" column="ZIP_CODE" />
	    <result property="birthdayDate" column="BIRTHDAY_DATE" />
	    <result property="joinDate" column="JOIN_DATE" />
	    <result property="leaveDate" column="LEAVE_DATE" />
	    <result property="passwordModifyDatetime" column="PASSWORD_MODIFY_DATETIME" />
	    <association property="dept" javaType="DeptDto">
	    	<id property="deptCode" column="DEPT_CODE" />
	    	<result property="deptName" column="DEPT_NAME" />
    	</association>
    	<association property="position" javaType="PositionDto">
	    	<id property="positionCode" column="POSITION_CODE" />
	    	<result property="positionName" column="POSITION_NAME" />
    	</association>
	</resultMap>
	
  <select id="getEmpByMap"
          parameterType="Map"
          resultMap="EmpDtoMap">
    SELECT  A.EMP_CODE, A.PASSWORD, A.EMP_NAME, A.PHONE,
        A.MOBILE, A.EMAIL, A.ZIP_CODE, A.ADDRESS, A.PROFILE_FILE_NAME,
        A.DETAIL_ADDRESS, A.BIRTHDAY_DATE, A.JOIN_DATE,
        A.SIGN_FILE_NAME, A.PASSWORD_MODIFY_DATETIME, A.STATUS_CODE, A.LEAVE_DATE,
        B.DEPT_CODE, B.DEPT_NAME, C.POSITION_CODE, C.POSITION_NAME
  FROM  EMP_T A, DEPT_T B, POSITION_T C
 WHERE  A.EMP_CODE = #{empCode} AND PASSWORD = #{pw}
   AND  A.DEPT_CODE = B.DEPT_CODE
   AND  A.POSITION_CODE = C.POSITION_CODE
  </select>
  
  <select id="getEmpCount"
  	      resultType="int">
    SELECT COUNT(*)
      FROM EMP_T
     WHERE STATUS_CODE IN ('s01', 's02') 
  </select>
  
  <select id="getEmpList"
  	      parameterType="Map"
  	      resultMap="EmpDtoMap">
  	SELECT E.EMP_CODE,
           E.EMP_NAME,
           D.DEPT_NAME,
           P.POSITION_NAME,
           E.MOBILE,
           E.EMAIL,
           E.STATUS_CODE,
      FROM EMP_T E
           LEFT JOIN DEPT_T D ON E.DEPT_CODE = D.DEPT_CODE
           INNER JOIN POSITION_T P ON E.POSITION_CODE = P.POSITION_CODE
     WHERE STATUS_CODE IN ('s01', 's02')
     ORDER BY EMP_CODE ASC
  </select>
  
  <select id="getSearchList"
  	      resultType="EmpDto">
  	SELECT EMP_CODE, EMP_NAME, DEPT_NAME, POSITION_NAME, MOBILE, EMAIL, STATUS_CODE
      FROM(SELECT ROW_NUMBER() OVER(ORDER BY E.EMP_CODE DESC) AS RN, E.EMP_CODE, E.EMP_NAME, D.DEPT_NAME, P.POSITION_NAME, E.MOBILE, E.EMAIL, E.STATUS_CODE
             FROM EMP_T E LEFT JOIN DEPT_T D
               ON E.DEPT_CODE = D.DEPT_CODE
            INNER JOIN POSITION_T P
               ON E.POSITION_CODE = P.POSITION_CODE
            WHERE STATUS_CODE IN ('s01', 's02')
              AND E.EMP_NAME LIKE CONCAT(CONCAT('%', #{query}), '%'))
    WHERE RN BETWEEN #{begin} AND #{end}
  </select>
  
  <select id="getSearchCount"
          parameterType="Map"
          resultType="int">
    SELECT COUNT(*)
      FROM EMP_T        	
	 WHERE EMP_NAME LIKE '%' || #{query} || '%'
  </select>
  
  <select id="getEmpDetail"
  		  parameterType="Map"
  		  resultMap="EmpDtoMap">
    SELECT E.EMP_CODE, E.EMP_NAME, E.PASSWORD, E.BIRTHDAY_DATE,
           E.JOIN_DATE, D.DEPT_NAME, P.POSITION_NAME, E.ZIP_CODE,
           E.ADDRESS, E.DETAIL_ADDRESS, E.MOBILE, E.EMAIL
      FROM EMP_T E
           LEFT JOIN DEPT_T  D ON E.DEPT_CODE = D.DEPT_CODE
           INNER JOIN POSITION_T P ON E.POSITION_CODE = P.POSITION_CODE
     WHERE E.EMP_CODE = #{empCode}
  </select>
  
  <insert id="insertEmployee">
    INSERT INTO EMP_T (
        EMP_CODE
      , EMP_NAME
      , PASSWORD
      , MOBILE
      , EMAIL
      , ZIP_CODE
      , ADDRESS
      , DETAIL_ADDRESS
      , POSITION_CODE
      , BIRTHDAY_DATE
      , JOIN_DATE
      , STATUS_CODE
      ) VALUES (
          #{empCode}
        , #{empName}
        , #{password}
        , #{mobile}
        , #{email}
        , #{zipCode}
        , #{address}
        , #{detailAddress}
        , #{positionCode}
        , #{birthdayDate}
        , CURRENT_DATE
        , 's01'
      )
  </insert>
  
  <update id="updateEmployee"
          parameterType="EmpDto">
	UPDATE EMP_T
	   SET EMP_NAME = #{empName},
	       EMP_CODE = #{empCode},
	       POSITION_CODE = #{positionCode},
	       MOBILE = #{mobile},
	       EMAIL = #{email},
	       BIRTHDAY_DATE = #{birthdayDate},
	       ZIP_CODE = #{zipCode},
	       ADDRESS = #{address},
		   DETAIL_ADDRESS = #{detailAddress}
	 WHERE EMP_CODE= #{empCode}
  </update>
  
  <update id="removeEmp">
	UPDATE EMP_T
	   SET STATUS_CODE = 's03',
	       LEAVE_DATE = CURRENT_DATE
	 WHERE EMP_CODE = #{empCode}
  </update>

  <select id="getDeptListByMap"
   		  parameterType="Map"
   		  resultType="DeptDto">
    SELECT D.DEPT_NAME, D.DEPT_CODE, D.DEPT_LEADER_EMP_NO, 
       (SELECT COUNT(*)
          FROM EMP_T E
         WHERE D.DEPT_CODE = E.DEPT_CODE) AS DEPT_HEADCOUNT,
       DEPT_CREATEDATE
      FROM DEPT_T D;
  </select>
  
  <update id="registerSign" parameterType="EmpDto">
	UPDATE EMP_T SET SIGN_FILE_NAME = #{signFileName} WHERE EMP_CODE = #{empCode}
  </update>
  
  <update id="updateInfo">
	UPDATE EMP_T
	   SET PHONE = #{phone},
	       MOBILE = #{mobile},
	       EMAIL = #{email},
	       ZIP_CODE = #{zipCode},
	       ADDRESS = #{address},
		   DETAIL_ADDRESS = #{detailAddress}
	 WHERE EMP_CODE= #{empCode}
  </update>

  <update id="updateProfile">
	UPDATE EMP_T
	   SET PROFILE_FILE_NAME = #{profileFileName}
	 WHERE EMP_CODE = #{empCode}
  </update>
  
  <select id="getEmpLeaveList"
  	      parameterType="Map"
  	      resultMap="EmpDtoMap">
  	SELECT EMP_T.EMP_CODE,
  		   EMP_T.EMP_NAME,
       	   DEPT_T.DEPT_NAME,
       	   POSITION_T.POSITION_NAME,
           EMP_T.MOBILE,
           EMP_T.STATUS_CODE,
           EMP_T.LEAVE_DATE
      FROM EMP_T
           INNER JOIN DEPT_T ON EMP_T.DEPT_CODE = DEPT_T.DEPT_CODE
           INNER JOIN POSITION_T ON EMP_T.POSITION_CODE = POSITION_T.POSITION_CODE
    WHERE STATUS_CODE = 's03'
    ORDER BY LEAVE_DATE DESC
  </select>
  
  <update id="empDeptTransfer">
	UPDATE EMP_T
	   SET DEPT_CODE = #{deptCode}
	 WHERE EMP_CODE = #{empCode}
	   AND EMP_CODE NOT IN (SELECT DEPT_LEADER_EMP_CODE
	                          FROM DEPT_T)	
  </update>
  
</mapper>